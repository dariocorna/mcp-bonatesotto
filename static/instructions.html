<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>MCP Server Instructions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 24px;
        background: #f5f7fb;
        color: #1f2933;
      }
      main {
        max-width: 820px;
        margin: auto;
      }
      h1 {
        margin-bottom: 0.25rem;
      }
      section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 12px 32px rgba(31, 41, 51, 0.08);
        padding: 24px;
        margin-bottom: 24px;
      }
      textarea {
        width: 100%;
        min-height: 220px;
        border-radius: 10px;
        border: 1px solid #cbd2d9;
        padding: 16px;
        font: inherit;
        resize: vertical;
      }
      button {
        background: #2563eb;
        border: none;
        color: #fff;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      button.secondary {
        background: #f3f4f6;
        color: #1f2933;
        margin-left: 8px;
      }
      pre {
        background: #f3f4f6;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <main>
      <section>
        <h1>MCP Server Instructions</h1>
        <p>
          Questa pagina mostra le istruzioni statiche fornite con il server e permette di
          aggiungere note locali che verranno restituite alle integrazioni MCP. Il contenuto
          statico Ã¨ letto da <code>static/instructions_static.md</code> mentre le note
          locali vengono salvate in <code>.mcp_cache/instructions.json</code>.
        </p>
        <p>
          Endpoint utili:
        </p>
        <ul>
          <li><code>GET /api/instructions</code> &rarr; restituisce `{ "static": "...", "extra": "..." }`</li>
          <li><code>POST /api/instructions</code> &rarr; accetta `{ "extra": "..." }`</li>
        </ul>
      </section>

      <section>
        <h2>Istruzioni statiche</h2>
        <p>
          Contenuto distribuito con il codice sorgente (solo lettura). Modifica il file
          <code>static/instructions_static.md</code> per aggiornare questa sezione.
        </p>
        <pre id="static-docs">Loading...</pre>
      </section>

      <section>
        <h2>Note locali</h2>
        <p>Modifica il testo e premi salva per aggiornare le istruzioni extra.</p>
        <textarea id="instructions" placeholder="Scrivi qui le tue note aggiuntive...">Loading...</textarea>
        <div style="margin-top: 12px;">
          <button id="save">Salva</button>
          <button id="clear" class="secondary">Svuota</button>
        </div>
        <p id="status" style="margin-top: 12px; font-size: 0.95rem;"></p>
      </section>
    </main>

    <script>
      async function loadInstructions() {
        try {
          const r = await fetch('/api/instructions');
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const j = await r.json();
          document.getElementById('instructions').value = j.extra || '';
          document.getElementById('static-docs').textContent = j.static || '(nessun contenuto statico trovato)';
        } catch (err) {
          document.getElementById('status').textContent = `Errore nel caricamento: ${err.message}`;
          document.getElementById('instructions').value = '';
          document.getElementById('static-docs').textContent = '(errore nel caricamento del contenuto statico)';
        }
      }

      async function saveInstructions() {
        const status = document.getElementById('status');
        status.textContent = 'Salvataggio in corso...';
        try {
          const payload = { extra: document.getElementById('instructions').value };
          const r = await fetch('/api/instructions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          status.textContent = 'Note salvate.';
        } catch (err) {
          status.textContent = `Errore nel salvataggio: ${err.message}`;
        }
      }

      document.getElementById('save').addEventListener('click', saveInstructions);
      document.getElementById('clear').addEventListener('click', () => {
        document.getElementById('instructions').value = '';
      });

      loadInstructions();
    </script>
  </body>
</html>
